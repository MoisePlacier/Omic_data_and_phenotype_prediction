library(doParallel)
library(data.table)
library(ggplot2)
library(nnet)
library(pls)
library(FactoMineR)
library(qqman)
library(mixOmics)
library(glmnet)
which.is.max(imp$importance)
imp[899901,]
imp[99901,]
imp[importance > 0.1]
imp[importance > 0]
imp[importance > -1]
imp$importance
imp <-readRDS("results/RF_all_pheno_all_snp/RF_Rust/RF_importance_Rust.rds")
imp
imp$importance
which.is.max(imp$importance)
imp[182800,]
filtered <- imp[SNP == "Chr15_3310098" & phenotype == "Rust", .(importance, iter)]
cols <- rainbow(length(unique(filtered$iter)))
cols_iter <- cols[as.numeric(factor(filtered$iter))]
# Plot
plot(filtered$importance, col = cols_iter, pch = 16,
xlab = "Index", ylab = "Importance", main = "Importance par itération")
legend("topright", legend = unique(filtered$iter), col = cols, pch = 16, title = "Iteration")
imp <-readRDS("results/RF_multi_pheno_null_res/RF_Rust/RF_scores_all_Rust.rds")
imp
which.is.max(imp$importance)
imp[6177422,]
filtered <- imp[SNP == "Chr04_8482985" & phenotype == "Rust", .(importance, iter)]
cols <- rainbow(length(unique(filtered$iter)))
cols_iter <- cols[as.numeric(factor(filtered$iter))]
# Plot
plot(filtered$importance, col = cols_iter, pch = 16,
xlab = "Index", ylab = "Importance", main = "Importance par itération")
legend("topright", legend = unique(filtered$iter), col = cols, pch = 16, title = "Iteration")
imp[importance > 0.1]
filtered <- imp[SNP == "Chr07_11556590" & phenotype == "Rust", .(importance, iter)]
cols <- rainbow(length(unique(filtered$iter)))
cols_iter <- cols[as.numeric(factor(filtered$iter))]
# Plot
plot(filtered$importance, col = cols_iter, pch = 16,
xlab = "Index", ylab = "Importance", main = "Importance par itération")
legend("topright", legend = unique(filtered$iter), col = cols, pch = 16, title = "Iteration")
filtered <- imp[SNP == "Chr15_9271580" & phenotype == "Rust", .(importance, iter)]
cols <- rainbow(length(unique(filtered$iter)))
cols_iter <- cols[as.numeric(factor(filtered$iter))]
# Plot
plot(filtered$importance, col = cols_iter, pch = 16,
xlab = "Index", ylab = "Importance", main = "Importance par itération")
legend("topright", legend = unique(filtered$iter), col = cols, pch = 16, title = "Iteration")
filtered <- imp[SNP == "Chr14_10007431" & phenotype == "Rust", .(importance, iter)]
cols <- rainbow(length(unique(filtered$iter)))
cols_iter <- cols[as.numeric(factor(filtered$iter))]
# Plot
plot(filtered$importance, col = cols_iter, pch = 16,
xlab = "Index", ylab = "Importance", main = "Importance par itération")
legend("topright", legend = unique(filtered$iter), col = cols, pch = 16, title = "Iteration")
filtered <- imp[SNP == "Chr11_4052328" & phenotype == "Rust", .(importance, iter)]
cols <- rainbow(length(unique(filtered$iter)))
cols_iter <- cols[as.numeric(factor(filtered$iter))]
# Plot
plot(filtered$importance, col = cols_iter, pch = 16,
xlab = "Index", ylab = "Importance", main = "Importance par itération")
legend("topright", legend = unique(filtered$iter), col = cols, pch = 16, title = "Iteration")
filtered <- imp[SNP == "Chr01_21860444" & phenotype == "Rust", .(importance, iter)]
cols <- rainbow(length(unique(filtered$iter)))
cols_iter <- cols[as.numeric(factor(filtered$iter))]
# Plot
plot(filtered$importance, col = cols_iter, pch = 16,
xlab = "Index", ylab = "Importance", main = "Importance par itération")
legend("topright", legend = unique(filtered$iter), col = cols, pch = 16, title = "Iteration")
imp[importance > 0.15]
imp[importance > 0.2]
filtered <- imp[SNP == "Chr08_1794430" & phenotype == "Rust", .(importance, iter)]
cols <- rainbow(length(unique(filtered$iter)))
cols_iter <- cols[as.numeric(factor(filtered$iter))]
# Plot
plot(filtered$importance, col = cols_iter, pch = 16,
xlab = "Index", ylab = "Importance", main = "Importance par itération")
legend("topright", legend = unique(filtered$iter), col = cols, pch = 16, title = "Iteration")
imp[importance > 0.25]
filtered <- imp[SNP == "Chr10_16278199" & phenotype == "Rust", .(importance, iter)]
cols <- rainbow(length(unique(filtered$iter)))
cols_iter <- cols[as.numeric(factor(filtered$iter))]
# Plot
plot(filtered$importance, col = cols_iter, pch = 16,
xlab = "Index", ylab = "Importance", main = "Importance par itération")
legend("topright", legend = unique(filtered$iter), col = cols, pch = 16, title = "Iteration")
imp[importance > 0.3]
filtered <- imp[SNP == "Chr04_4339177" & phenotype == "Rust", .(importance, iter)]
cols <- rainbow(length(unique(filtered$iter)))
cols_iter <- cols[as.numeric(factor(filtered$iter))]
# Plot
plot(filtered$importance, col = cols_iter, pch = 16,
xlab = "Index", ylab = "Importance", main = "Importance par itération")
legend("topright", legend = unique(filtered$iter), col = cols, pch = 16, title = "Iteration")
imp <-readRDS("results/RF_scores_res/RF_Rust/RF_scores_all_Rust.rds")
imp <-readRDS("results/RF_scores_res/RF_CIRC_2009/RF_scores_all_CIRC_2009.rds")
imp <-readRDS("results/RF_scores_res/RF_CIRC2009/RF_scores_all_CIRC2009.rds")
imp
which.is.max(imp$importance)
imp[21067236,]
filtered <- imp[SNP == "Chr18_14066531" & phenotype == "Rust", .(importance, iter)]
cols <- rainbow(length(unique(filtered$iter)))
cols_iter <- cols[as.numeric(factor(filtered$iter))]
# Plot
plot(filtered$importance, col = cols_iter, pch = 16,
xlab = "Index", ylab = "Importance", main = "Importance par itération")
filtered <- imp[SNP == "Chr18_14066531" & phenotype == "CIRC2011", .(importance, iter)]
cols <- rainbow(length(unique(filtered$iter)))
cols_iter <- cols[as.numeric(factor(filtered$iter))]
# Plot
plot(filtered$importance, col = cols_iter, pch = 16,
xlab = "Index", ylab = "Importance", main = "Importance par itération")
filtered <- imp[SNP == "Chr18_14066531" & phenotype == "CIRC2009", .(importance, iter)]
cols <- rainbow(length(unique(filtered$iter)))
cols_iter <- cols[as.numeric(factor(filtered$iter))]
# Plot
plot(filtered$importance, col = cols_iter, pch = 16,
xlab = "Index", ylab = "Importance", main = "Importance par itération")
legend("topright", legend = unique(filtered$iter), col = cols, pch = 16, title = "Iteration")
imp[importance > 0.3]
imp[importance > 0.35]
imp[importance > 0.4]
filtered <- imp[SNP == "Chr08_5745886" & phenotype == "CIRC2009", .(importance, iter)]
cols <- rainbow(length(unique(filtered$iter)))
cols_iter <- cols[as.numeric(factor(filtered$iter))]
# Plot
plot(filtered$importance, col = cols_iter, pch = 16,
xlab = "Index", ylab = "Importance", main = "Importance par itération")
legend("topright", legend = unique(filtered$iter), col = cols, pch = 16, title = "Iteration")
imp[importance > 0.45]
filtered <- imp[SNP == "Chr16_11351593" & phenotype == "CIRC2009", .(importance, iter)]
cols <- rainbow(length(unique(filtered$iter)))
cols_iter <- cols[as.numeric(factor(filtered$iter))]
# Plot
plot(filtered$importance, col = cols_iter, pch = 16,
xlab = "Index", ylab = "Importance", main = "Importance par itération")
legend("topright", legend = unique(filtered$iter), col = cols, pch = 16, title = "Iteration")
# ggplot pour heatmap
overlap_df <- as.data.table(as.table(overlap_mat))
library(pls)
library(caret)
library(data.table)
library(parallel)
library(doParallel)
library(data.table)
library(ggplot2)
library(nnet)
library(pls)
library(FactoMineR)
library(qqman)
library(mixOmics)
library(glmnet)
library(corrplot)
library(arrow)
cols_to_read <- c(
"SNP", "phenotype", "method", "context", "mean","sd")
all_scores_dt <- read_parquet("Pipelines_scoring_SNP/results/all_scores_merged.parquet",
as_data_table = TRUE,
col_select = cols_to_read)
# Classement basé sur la moyenne
# colonne 'mean' comme score global pour le ranking
all_scores_dt[, rank := frank(-mean, ties.method = "average"), by = .(phenotype, method, context)]
# 1. Z-score
all_scores_dt[, score_z := (mean - mean(mean, na.rm = TRUE)) / sd(mean, na.rm = TRUE),
by = .(phenotype, method, context)]
# 2. Min-max scaling sur le z-score pour avoir 0-1
all_scores_dt[, score_scaled := (score_z - min(score_z, na.rm = TRUE)) /
(max(score_z, na.rm = TRUE) - min(score_z, na.rm = TRUE)),
by = .(phenotype, method)]
all_scores_dt[, method_context := paste(method, context, sep = "_")]
all_scores_dt[, method_context := factor(method_context, levels = unique(method_context))]
tmp <- tstrsplit(all_scores_dt$SNP, "_")
all_scores_dt[, chrom := tmp[[1]]]
all_scores_dt[, pos   := as.numeric(tmp[[2]])]
all_scores_dt[, chrom_num := as.numeric(sub("^Chr", "", chrom))]
library(data.table)
library(ggplot2)
# --- Liste unique des combinaisons méthode × contexte ---
method_context_list <- unique(all_scores_dt[, .(method, context)])
method_context_list[, method_context := paste(method, context, sep = "_")]
# --- Fonction pour calculer le recouvrement topK entre deux combinaisons pour un phéno ---
topK_overlap_mc <- function(dt, pheno, mc1, mc2, topK = 100) {
# Séparer méthode et contexte
mc1_split <- strsplit(mc1, "_")[[1]]
mc2_split <- strsplit(mc2, "_")[[1]]
# Extraire les rangs en évitant le conflit avec la fonction rank()
dt1 <- dt[phenotype == pheno & method == mc1_split[1] & context == mc1_split[2],
.(SNP, rank1 = get("rank"))]
dt1 <- dt1[!is.na(rank1)]
dt2 <- dt[phenotype == pheno & method == mc2_split[1] & context == mc2_split[2],
.(SNP, rank2 = get("rank"))]
dt2 <- dt2[!is.na(rank2)]
# Si une des combinaisons est absente
if(nrow(dt1) == 0 || nrow(dt2) == 0) return(NA_real_)
# Merge sur les SNPs communs
merged <- merge(dt1, dt2, by = "SNP")
if(nrow(merged) == 0) return(0)
# TopK overlap
top1 <- merged[order(rank1)][1:min(topK, .N), SNP]
top2 <- merged[order(rank2)][1:min(topK, .N), SNP]
length(intersect(top1, top2)) / min(topK, .N)
}
# --- Fonction pour construire la matrice de recouvrement topK pour un phéno ---
make_overlap_matrix <- function(dt, pheno, topK = 100) {
mc_vec <- method_context_list$method_context
mat <- matrix(NA_real_, nrow = length(mc_vec), ncol = length(mc_vec),
dimnames = list(mc_vec, mc_vec))
for(i in seq_along(mc_vec)) {
for(j in seq_along(mc_vec)) {
mat[i, j] <- topK_overlap_mc(dt, pheno, mc_vec[i], mc_vec[j], topK)
}
}
mat
}
plot_overlap <- function(overlap_df){
ggplot(overlap_df, aes(x = Var2, y = Var1, fill = value)) +
geom_tile() +
geom_text(aes(label = round(value, 2))) +
scale_fill_gradient(low = "white", high = "steelblue", na.value = "grey90") +
labs(title = paste("Top", 1000, "SNP overlap "),
x = "Méthode × Contexte", y = "Méthode × Contexte") +
theme_minimal() +
theme(axis.text.x = element_text(angle = 45, hjust = 1))}
pheno_example <- "CIRC2009"
overlap_mat <- make_overlap_matrix(all_scores_dt, pheno_example, topK = 1000)
overlap_mat_null <- make_overlap_matrix(all_scores_dt, "pheno_null", topK = 1000)
# ggplot pour heatmap
overlap_df <- as.data.table(as.table(overlap_mat))
setnames(overlap_df, c("Var1","Var2","value"))
plot_overlap(overlap_df)
overlap_mat_null <- make_overlap_matrix(all_scores_dt, "pheno_null", topK = 1000)
overlap_mat_kin <- make_overlap_matrix(all_scores_dt, "pheno_kin_aware", topK = 1000)
overlap_mat_pop <- make_overlap_matrix(all_scores_dt, "pheno_pop_aware", topK = 1000)
dt_plot <- all_scores_dt[
method_context %in% c("RF_residuals","RF_phenotype","VIP_phenotype","FarmCPU_GWAS","MLM_GWAS") &
chrom %in% c("Chr13") &
#rank <200 &
phenotype %in% c("pheno_null","pheno_kin_aware","pheno_pop_aware","CIRC2009","BudFlushSlope")
]
ggplot(dt_plot, aes(x = pos, y = score_scaled, color = phenotype, alpha = score_scaled)) +
geom_point(size = 1) +
facet_grid(method_context ~ chrom, scales = "free_x") +
coord_cartesian(ylim = c(0,1)) +  # force y entre 0 et 1 sans couper les données
theme_minimal() +
labs(
title = "Scores moyens des SNP du chromosome 10 par phénotype et méthode de scoring",
x = "Position SNP",
y = "Score normalisé",
alpha = "Score"
) +
theme(
axis.text.x = element_text(angle = 45, hjust = 1),
strip.text.y = element_text(angle = 0)
)
dt_plot <- all_scores_dt[
method_context %in% c("RF_residuals","RF_phenotype","VIP_phenotype","FarmCPU_GWAS","MLM_GWAS") &
chrom %in% c("Chr13") &
rank <100 &
phenotype %in% c("pheno_null","pheno_kin_aware","pheno_pop_aware","CIRC2009","BudFlushSlope")
]
ggplot(dt_plot, aes(x = pos, y = score_scaled, color = phenotype, alpha = score_scaled)) +
geom_point(size = 1) +
facet_grid(method_context ~ chrom, scales = "free_x") +
coord_cartesian(ylim = c(0,1)) +  # force y entre 0 et 1 sans couper les données
theme_minimal() +
labs(
title = "Scores moyens des SNP du chromosome 10 par phénotype et méthode de scoring",
x = "Position SNP",
y = "Score normalisé",
alpha = "Score"
) +
theme(
axis.text.x = element_text(angle = 45, hjust = 1),
strip.text.y = element_text(angle = 0)
)
library(ggplot2)
library(plotly)
p <- ggplot(
dt_plot,
aes(
x = pos,
y = score_scaled,
color = phenotype,
text = paste0("SNP: ", SNP, "<br>",
"Score: ", round(score_scaled,3), "<br>",
"Rank: ", rank))  # info affichée au survol
) +
geom_point(size = 2, alpha = 0.7) +
facet_grid(method_context ~ chrom, scales = "free_x") +
scale_y_continuous(breaks = c(0,1)) +
theme_minimal() +
theme(
axis.text.x. = element_text(angle = 45, hjust = 1),
strip.text.y = element_text(angle = 0)
)
ggplotly(p, tooltip = "text")  # rend le graphique interactif
dt_plot <- all_scores_dt[
method_context %in% c("RF_residuals","RF_phenotype","VIP_phenotype","FarmCPU_GWAS","MLM_GWAS") &
chrom %in% c("Chr13") &
rank <200 &
phenotype %in% c("pheno_null","pheno_kin_aware","pheno_pop_aware","CIRC2009","BudFlushSlope")
]
ggplot(dt_plot, aes(x = pos, y = score_scaled, color = phenotype, alpha = score_scaled)) +
geom_point(size = 1) +
facet_grid(method_context ~ chrom, scales = "free_x") +
coord_cartesian(ylim = c(0,1)) +  # force y entre 0 et 1 sans couper les données
theme_minimal() +
labs(
title = "Scores moyens des SNP du chromosome 10 par phénotype et méthode de scoring",
x = "Position SNP",
y = "Score normalisé",
alpha = "Score"
) +
theme(
axis.text.x = element_text(angle = 45, hjust = 1),
strip.text.y = element_text(angle = 0)
)
library(ggplot2)
library(plotly)
p <- ggplot(
dt_plot,
aes(
x = pos,
y = score_scaled,
color = phenotype,
text = paste0("SNP: ", SNP, "<br>",
"Score: ", round(score_scaled,3), "<br>",
"Rank: ", rank))  # info affichée au survol
) +
geom_point(size = 2, alpha = 0.7) +
facet_grid(method_context ~ chrom, scales = "free_x") +
scale_y_continuous(breaks = c(0,1)) +
theme_minimal() +
theme(
axis.text.x. = element_text(angle = 45, hjust = 1),
strip.text.y = element_text(angle = 0)
)
ggplotly(p, tooltip = "text")  # rend le graphique interactif
dt_plot <- all_scores_dt[
method_context %in% c("RF_residuals","RF_phenotype","VIP_phenotype","FarmCPU_GWAS","MLM_GWAS") &
chrom %in% c("Chr12") &
rank <200 &
phenotype %in% c("pheno_null","Rust","pheno_pop_aware","CIRC2009","BudFlushSlope")
]
ggplot(dt_plot, aes(x = pos, y = score_scaled, color = phenotype, alpha = score_scaled)) +
geom_point(size = 1) +
facet_grid(method_context ~ chrom, scales = "free_x") +
coord_cartesian(ylim = c(0,1)) +  # force y entre 0 et 1 sans couper les données
theme_minimal() +
labs(
title = "Scores moyens des SNP du chromosome 10 par phénotype et méthode de scoring",
x = "Position SNP",
y = "Score normalisé",
alpha = "Score"
) +
theme(
axis.text.x = element_text(angle = 45, hjust = 1),
strip.text.y = element_text(angle = 0)
)
library(ggplot2)
library(plotly)
p <- ggplot(
dt_plot,
aes(
x = pos,
y = score_scaled,
color = phenotype,
text = paste0("SNP: ", SNP, "<br>",
"Score: ", round(score_scaled,3), "<br>",
"Rank: ", rank))  # info affichée au survol
) +
geom_point(size = 2, alpha = 0.7) +
facet_grid(method_context ~ chrom, scales = "free_x") +
scale_y_continuous(breaks = c(0,1)) +
theme_minimal() +
theme(
axis.text.x. = element_text(angle = 45, hjust = 1),
strip.text.y = element_text(angle = 0)
)
ggplotly(p, tooltip = "text")  # rend le graphique interactif
overlap_rust <- make_overlap_matrix(all_scores_dt, "Rust", topK = 1000)
# ggplot pour heatmap
overlap_df <- as.data.table(as.table(overlap_rust))
setnames(overlap_df, c("Var1","Var2","value"))
plot_overlap(overlap_df)
overlap_rust <- make_overlap_matrix(all_scores_dt, "Rust", topK = 100)
# ggplot pour heatmap
overlap_df <- as.data.table(as.table(overlap_rust))
setnames(overlap_df, c("Var1","Var2","value"))
plot_overlap(overlap_df)
overlap_BudFlushSlope <- make_overlap_matrix(all_scores_dt, "BudFlushSlope", topK = 100)
# ggplot pour heatmap
overlap_df <- as.data.table(as.table(overlap_BudFlushSlope))
setnames(overlap_df, c("Var1","Var2","value"))
plot_overlap(overlap_df)
dt_plot <- all_scores_dt[
method_context %in% c("RF_residuals","RF_phenotype","VIP_phenotype","FarmCPU_GWAS","MLM_GWAS") &
chrom %in% c("Chr13") &
rank <200 &
phenotype %in% c("pheno_null","pheno_kin_aware","pheno_pop_aware","CIRC2009","BudFlushSlope")
]
ggplot(dt_plot, aes(x = pos, y = score_scaled, color = phenotype, alpha = score_scaled)) +
geom_point(size = 1) +
facet_grid(method_context ~ chrom, scales = "free_x") +
coord_cartesian(ylim = c(0,1)) +  # force y entre 0 et 1 sans couper les données
theme_minimal() +
labs(
title = "Scores moyens des SNP du chromosome 10 par phénotype et méthode de scoring",
x = "Position SNP",
y = "Score normalisé",
alpha = "Score"
) +
theme(
axis.text.x = element_text(angle = 45, hjust = 1),
strip.text.y = element_text(angle = 0)
)
dt_plot <- all_scores_dt[
method_context %in% c("RF_residuals","RF_phenotype","VIP_phenotype","VIP_residuals","FarmCPU_GWAS","MLM_GWAS") &
chrom %in% c("Chr13") &
rank <200 &
phenotype %in% c("pheno_null","pheno_kin_aware","pheno_pop_aware","CIRC2009","BudFlushSlope")
]
ggplot(dt_plot, aes(x = pos, y = score_scaled, color = phenotype, alpha = score_scaled)) +
geom_point(size = 1) +
facet_grid(method_context ~ chrom, scales = "free_x") +
coord_cartesian(ylim = c(0,1)) +  # force y entre 0 et 1 sans couper les données
theme_minimal() +
labs(
title = "Scores moyens des SNP du chromosome 10 par phénotype et méthode de scoring",
x = "Position SNP",
y = "Score normalisé",
alpha = "Score"
) +
theme(
axis.text.x = element_text(angle = 45, hjust = 1),
strip.text.y = element_text(angle = 0)
)
library(ggplot2)
library(plotly)
p <- ggplot(
dt_plot,
aes(
x = pos,
y = score_scaled,
color = phenotype,
text = paste0("SNP: ", SNP, "<br>",
"Score: ", round(score_scaled,3), "<br>",
"Rank: ", rank))  # info affichée au survol
) +
geom_point(size = 2, alpha = 0.7) +
facet_grid(method_context ~ chrom, scales = "free_x") +
scale_y_continuous(breaks = c(0,1)) +
theme_minimal() +
theme(
axis.text.x. = element_text(angle = 45, hjust = 1),
strip.text.y = element_text(angle = 0)
)
ggplotly(p, tooltip = "text")  # rend le graphique interactif
Genomic_FILE <- "../data/Genomic.rda"
load(Genomic_FILE)
geno <- as.data.table(Genomic)
Loc_FILE <- "../data/localisation.rda"
load(Loc_FILE)
loc_df<- as.data.table(localisation)
pheno <- as.data.table(pheno_all)
Genomic_FILE <- "../data/Genomic.rda"
load(Genomic_FILE)
geno <- as.data.table(Genomic)
Loc_FILE <- "../data/localisation.rda"
load(Loc_FILE)
loc_df<- as.data.table(localisation)
Pheno_FILE <- "data/pheno_null.rds"
pheno<- as.data.table(readRDS(Pheno_FILE))
Loc_FILE <- "data/localisation.rda"
load(Loc_FILE)
Loc_FILE <- "../data/localisation.rda"
load(Loc_FILE)
loc_df<- as.data.table(localisation)
Pheno_FILE <- "../data/pheno_null.rds"
pheno<- as.data.table(readRDS(Pheno_FILE))
geno[, ID := rownames(Genomic)]
pheno[, ID := rownames(Phenotype)]
Loc_FILE <- "../data/localisation.rda"
load(Loc_FILE)
loc_df<- as.data.table(localisation)
Pheno_FILE <- "../data/pheno_null.rds"
pheno<- as.data.table(readRDS(Pheno_FILE))
geno[, ID := rownames(Genomic)]
pheno[, ID := rownames(Genomic)]
merged<- merge(pheno, loc_df[,list(Population,ID)], by = "ID")
merged
ggplot(merged,aes(x=Population, y = pheno_pop_aware) +
geom_boxplot())
merged
ggplot(merged, aes(x=Population, y = pheno_pop_aware)) +
geom_boxplot()
merged
ggplot(merged, aes(x=Population, y = pheno_null)) +
geom_boxplot()
merged
ggplot(merged, aes(x=Population, y = pheno_kin_aware)) +
geom_boxplot()
merged
ggplot(merged, aes(x=Population, y = pheno_pop_aware)) +
geom_boxplot()
merged
