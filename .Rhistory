size = 3,
inherit.aes = FALSE
) +
facet_wrap(~ phenotype + model, scales = "fixed") +
coord_cartesian(ylim = c(0, 1)) +
labs(
x = "Méthode de scoring",
y = expression(R^2),
title = "Performances ridge en fonction de la méthode de sélection du top 500 SNP"
) +
theme_minimal() +
theme(
axis.text.x = element_text(angle = 45, hjust = 1),
strip.text = element_text(face = "bold")
) +
scale_fill_brewer(palette = "Set2")
ggplot(ridge_perf, aes(x = method_context, y = R2, fill = context)) +
geom_boxplot() +
geom_text(
data = med_dt,
aes(
x = method_context,
y = R2_median,
label = sprintf("%.2f", R2_median)
),
vjust = -1.5,
size = 3,
inherit.aes = FALSE
) +
facet_wrap(~ phenotype + model, scales = "fixed") +
coord_cartesian(ylim = c(0, 1)) +
labs(
x = "Méthode de scoring",
y = expression(R^2),
title = "Performances ridge en fonction de la méthode de sélection du top 500 SNP"
) +
theme_minimal() +
theme(
axis.text.x = element_text(angle = 45, hjust = 1),
strip.text = element_text(face = "bold")
) +
scale_fill_brewer(palette = "Set2")
ggplot(ridge_perf, aes(x = method_context, y = R2, fill = context)) +
geom_boxplot() +
geom_text(
data = med_dt,
aes(
x = method_context,
y = R2_median,
label = sprintf("%.2f", R2_median)
),
vjust = -1.9,
size = 3,
inherit.aes = FALSE
) +
facet_wrap(~ phenotype + model, scales = "fixed") +
coord_cartesian(ylim = c(0, 1)) +
labs(
x = "Méthode de scoring",
y = expression(R^2),
title = "Performances ridge en fonction de la méthode de sélection du top 500 SNP"
) +
theme_minimal() +
theme(
axis.text.x = element_text(angle = 45, hjust = 1),
strip.text = element_text(face = "bold")
) +
scale_fill_brewer(palette = "Set2")
ggplot(ridge_perf, aes(x = method_context, y = R2, fill = context)) +
geom_boxplot() +
geom_text(
data = med_dt,
aes(
x = method_context,
y = R2_median,
label = sprintf("%.2f", R2_median)
),
vjust = -2.4,
size = 3,
inherit.aes = FALSE
) +
facet_wrap(~ phenotype + model, scales = "fixed") +
coord_cartesian(ylim = c(0, 1)) +
labs(
x = "Méthode de scoring",
y = expression(R^2),
title = "Performances ridge en fonction de la méthode de sélection du top 500 SNP"
) +
theme_minimal() +
theme(
axis.text.x = element_text(angle = 45, hjust = 1),
strip.text = element_text(face = "bold")
) +
scale_fill_brewer(palette = "Set2")
ggplot(ridge_perf, aes(x = method_context, y = R2, fill = context)) +
geom_boxplot() +
geom_text(
data = med_dt,
aes(
x = method_context,
y = R2_median,
label = sprintf("%.2f", R2_median)
),
vjust = -2.4,
size = 4,
inherit.aes = FALSE
) +
facet_wrap(~ phenotype + model, scales = "fixed") +
coord_cartesian(ylim = c(0, 1)) +
labs(
x = "Méthode de scoring",
y = expression(R^2),
title = "Performances ridge en fonction de la méthode de sélection du top 500 SNP"
) +
theme_minimal() +
theme(
axis.text.x = element_text(angle = 45, hjust = 1),
strip.text = element_text(face = "bold")
) +
scale_fill_brewer(palette = "Set2")
ggplot(ridge_perf, aes(x = method_context, y = R2, fill = context)) +
geom_boxplot() +
geom_text(
data = med_dt,
aes(
x = method_context,
y = R2_median,
label = sprintf("%.2f", R2_median)
),
vjust = -2.4,
size = 4,
inherit.aes = FALSE
) +
facet_wrap(~ phenotype + model, scales = "fixed") +
coord_cartesian(ylim = c(0, 1)) +
labs(
x = "Méthode de scoring",
y = expression(R^2),
title = "Performances ridge en fonction de la méthode de sélection du top 1000 SNP"
) +
theme_minimal() +
theme(
axis.text.x = element_text(angle = 45, hjust = 1),
strip.text = element_text(face = "bold")
) +
scale_fill_brewer(palette = "Set2")
?frank
library(data.table)
library(ggplot2)
library(parallel)
library(corrplot)
library(data.table)
library(ggplot2)
library(parallel)
library(corrplot)
cols_to_read <- c(
"SNP", "phenotype", "method", "context",
"n_obs", "mean", "median", "sd", "q90", "q95", "max"
)
all_scores_dt <- read_parquet("results/all_scores.parquet",
as_data_table = TRUE,
col_select = cols_to_read)
cols_to_read <- c(
"SNP", "phenotype", "method", "context",
"n_obs", "mean", "median", "sd", "q90", "q95", "max"
)
all_scores_dt <- read_parquet("Pipelines_scoring_SNP/results/all_scores.parquet",
as_data_table = TRUE,
col_select = cols_to_read)
# Classement basé sur la moyenne
# colonne 'mean' comme score global pour le ranking
all_scores_dt[, absmean := abs(mean)]
all_scores_dt[, rank := frank(-absmean, ties.method = "average"), by = .(phenotype, method, context)]
# Normalisation robuste des scores basée sur la moyenne
all_scores_dt[, score_scaled := (mean - mean(mean, na.rm = TRUE)) / sd(mean, na.rm = TRUE),
by = .(phenotype, method)]
tmp <- tstrsplit(all_scores_dt$SNP, "_")
all_scores_dt[, chrom := tmp[[1]]]
all_scores_dt[, pos   := as.numeric(tmp[[2]])]
all_scores_dt[, chrom_num := as.numeric(sub("^Chr", "", chrom))]
head(all_scores_dt)
get_scores_for_pheno <- function(dt, pheno, method, context1, context2) {
dt1 <- dt[phenotype == pheno & method == method & context == context1,
.(SNP, score1 = score_scaled, rank1 = rank)]
dt2 <- dt[phenotype == pheno & method == method & context == context2,
.(SNP, score2 = score_scaled , rank2 = rank)]
merged <- merge(dt1, dt2, by = "SNP")
return(merged)
}
dt1 <- all_scores_dt[phenotype == "CIRC2009" & method == "RF" & context == "phenotype",
.(SNP, score1 = score_scaled, rank1 = rank)]
dt2 <- all_scores_dt[phenotype == "HT2009" & method == "RF" & context == "phenotype",
.(SNP, score2 = score_scaled , rank2 = rank)]
merged <- merge(dt1, dt2, by = "SNP")
spearman_all <- cor(dt1$score1, dt2$score2, method = "spearman")
spearman_all
topK <- 1000
top1 <- dt1[order(rank1)][1:topK, SNP]
top2 <- dt2[order(rank2)][1:topK, SNP]
overlap <- length(intersect(top1, top2))
overlap
overlap_prop <- overlap / topK
overlap_prop
library(data.table)
# Fonction pour comparer deux phénotypes pour une méthode et un contexte
compare_pheno_pair <- function(dt, ph1, ph2, method_sel, context_sel, topK = 1000) {
# Extraire les scores pour chaque phénotype
dt1 <- dt[phenotype == ph1 & method == method_sel & context == context_sel,
.(SNP, score1 = score_scaled, rank1 = rank)]
dt2 <- dt[phenotype == ph2 & method == method_sel & context == context_sel,
.(SNP, score2 = score_scaled, rank2 = rank)]
merged <- merge(dt1, dt2, by = "SNP")
print(c(dim(merged),ph1,ph2))
# Corrélation de Spearman
spearman <- cor(merged$score1, merged$score2, method = "spearman", use = "complete.obs")
# TOP K overlap
top1 <- merged[order(rank1)][1:topK, SNP]
top2 <- merged[order(rank2)][1:topK, SNP]
overlap_prop <- length(intersect(top1, top2)) / topK
data.table(
pheno1 = ph1,
pheno2 = ph2,
method = method_sel,
context = context_sel,
spearman = spearman,
topK_overlap = overlap_prop
)
}
# Fonction pour générer la matrice complète de comparaisons phénotypes
compare_all_phenos <- function(dt, phenos, method_sel, context_sel, topK = 1000) {
res_list <- list()
for(i in 1:(length(phenos)-1)) {
for(j in (i+1):length(phenos)) {
res_list[[length(res_list)+1]] <- compare_pheno_pair(
dt, phenos[i], phenos[j], method_sel, context_sel, topK
)
}
}
rbindlist(res_list)
}
phenos_run <- c("CIRC2009","CIRC2011","HT2009","BudFlushSlope","BrAnglVert","Dia2015_sqrt","RamifSyllep")
method_run <- "RF"
context_run <- "phenotype"
topK_run <- 100
res_compare_pheno <- compare_all_phenos(all_scores_dt, phenos_run, method_run, context_run, topK_run)
phenos_run <- c("CIRC2009","CIRC2011","HT2009","BudFlushSlope","BrAnglVert","Dia2015_sqrt","RamifSyllep")
method_run <- "RF"
context_run <- "residuals"
topK_run <- 100
res_compare_res <- compare_all_phenos(all_scores_dt, phenos_run, method_run, context_run, topK_run)
res_compare_res
library(data.table)
library(ggplot2)
compare_pheno_pair_safe <- function(dt, ph1, ph2, method_sel, context_sel, topK = 1000) {
# Extraire les scores et retirer les NA
dt1 <- dt[phenotype == ph1 & method == method_sel & context == context_sel,
.(SNP, score1 = score_scaled, rank1 = rank)]
dt1 <- dt1[!is.na(score1)]
dt2 <- dt[phenotype == ph2 & method == method_sel & context == context_sel,
.(SNP, score2 = score_scaled, rank2 = rank)]
dt2 <- dt2[!is.na(score2)]
# Merge en gardant seulement les SNPs communs
merged <- merge(dt1, dt2, by = "SNP")
# Si pas de SNP commun
if(nrow(merged) == 0) {
return(data.table(
pheno1 = ph1, pheno2 = ph2,
method = method_sel, context = context_sel,
spearman = NA_real_, topK_overlap = NA_real_
))
}
# Corrélation de Spearman
spearman <- cor(merged$score1, merged$score2, method = "spearman", use = "complete.obs")
# TOP K overlap
top1 <- merged[order(rank1)][1:min(topK, .N), SNP]
top2 <- merged[order(rank2)][1:min(topK, .N), SNP]
overlap_prop <- length(intersect(top1, top2)) / min(topK, .N)
data.table(
pheno1 = ph1, pheno2 = ph2,
method = method_sel, context = context_sel,
spearman = spearman, topK_overlap = overlap_prop
)
}
compare_all_phenos_full_safe <- function(dt, phenos, method_sel, context_sel, topK = 1000) {
res_list <- list()
for(ph1 in phenos) {
for(ph2 in phenos) {
res_list[[length(res_list)+1]] <- compare_pheno_pair_safe(
dt, ph1, ph2, method_sel, context_sel, topK
)
}
}
rbindlist(res_list)
}
phenos_run <- c("CIRC2009","CIRC2011","HT2009","BudFlushSlope","BrAnglVert","Dia2015_sqrt","RamifSyllep")
method_run <- "RF"
context_run <- "phenotype"
topK_run <- 100
res_pheno <- compare_all_phenos_full_safe(all_scores_dt, phenos_run, method_run, context_run, topK_run)
phenos_run <- c("CIRC2009","CIRC2011","HT2009","BudFlushSlope","BrAnglVert","Dia2015_sqrt","RamifSyllep")
method_run <- "RF"
context_run <- "residuals"
topK_run <- 100
res_res <- compare_all_phenos_full_safe(all_scores_dt, phenos_run, method_run, context_run, topK_run)
# Ajouter une colonne pour indiquer le contexte
res_pheno[, context := "phenotype"]
res_res[, context := "residuals"]
# Fusionner les deux résultats pour comparer
res_all <- rbind(res_pheno, res_res)
# Heatmap Spearman
ggplot(res_all, aes(x = pheno1, y = pheno2, fill = spearman)) +
geom_tile() +
facet_wrap(~ context) +
scale_fill_gradient2(low = "blue", mid = "white", high = "red", midpoint = 0) +
theme_minimal() +
labs(
title = "Spearman correlation sur les scores de l'ensemble des SNP entre phénotypes",
fill = "rho"
) +
theme(axis.text.x = element_text(angle = 45, hjust = 1))
# Heatmap TOP K overlap
ggplot(res_all, aes(x = pheno1, y = pheno2, fill = topK_overlap)) +
geom_tile() +
facet_wrap(~ context) +
scale_fill_gradient(low = "white", high = "red") +
theme_minimal() +
labs(
title = paste0("Proportion TOP ", topK_run, " SNPs communs entre phénotypes"),
fill = "TOP K overlap"
) +
theme(axis.text.x = element_text(angle = 45, hjust = 1))
####################################
############ RF ####################
####################################
phenos_run <- c("CIRC2009","CIRC2011","HT2009","BudFlushSlope","BrAnglVert","Dia2015_sqrt","RamifSyllep")
method_run <- "RF"
context_run <- "phenotype"
topK_run <- 100
RF_res_pheno <- compare_all_phenos_full_safe(all_scores_dt, phenos_run, method_run, context_run, topK_run)
phenos_run <- c("CIRC2009","CIRC2011","HT2009","BudFlushSlope","BrAnglVert","Dia2015_sqrt","RamifSyllep")
method_run <- "RF"
context_run <- "residuals"
topK_run <- 100
RF_res_res <- compare_all_phenos_full_safe(all_scores_dt, phenos_run, method_run, context_run, topK_run)
####################################
############ VIP ###################
####################################
phenos_run <- c("CIRC2009","CIRC2011","HT2009","BudFlushSlope","BrAnglVert","Dia2015_sqrt","RamifSyllep")
method_run <- "VIP"
context_run <- "phenotype"
topK_run <- 100
VIP_res_pheno <- compare_all_phenos_full_safe(all_scores_dt, phenos_run, method_run, context_run, topK_run)
phenos_run <- c("CIRC2009","CIRC2011","HT2009","BudFlushSlope","BrAnglVert","Dia2015_sqrt","RamifSyllep")
method_run <- "VIP"
context_run <- "residuals"
topK_run <- 100
VIP_res_res <- compare_all_phenos_full_safe(all_scores_dt, phenos_run, method_run, context_run, topK_run)
# Ajouter une colonne pour indiquer le contexte
RF_res_pheno[, context := "RF_phenotype"]
RF_res_res[, context := "RF_residuals"]
VIP_res_pheno[, context := "VIP_phenotype"]
VIP_res_res[, context := "VIP_residuals"]
# Fusionner les deux résultats pour comparer
res_all <- rbind(RF_res_pheno, RF_res_res,VIP_res_pheno,VIP_res_res)
# Heatmap Spearman
ggplot(res_all, aes(x = pheno1, y = pheno2, fill = spearman)) +
geom_tile() +
facet_wrap(~ context) +
scale_fill_gradient2(low = "blue", mid = "white", high = "red", midpoint = 0) +
theme_minimal() +
labs(
title = "Spearman correlation sur les scores de l'ensemble des SNP entre phénotypes",
fill = "rho"
) +
theme(axis.text.x = element_text(angle = 45, hjust = 1))
# Heatmap TOP K overlap
ggplot(res_all, aes(x = pheno1, y = pheno2, fill = topK_overlap)) +
geom_tile() +
facet_wrap(~ context) +
scale_fill_gradient(low = "white", high = "red") +
theme_minimal() +
labs(
title = paste0("Proportion TOP ", topK_run, " SNPs communs entre phénotypes"),
fill = "TOP K overlap"
) +
theme(axis.text.x = element_text(angle = 45, hjust = 1))
VIP_res_res
dt1 <- all_scores_dt[phenotype == "CIRC2009" & method == "VIP" & context == "phenotype",
.(SNP, score1 = score_scaled, rank1 = rank)]
dt1 <- all_scores_dt[phenotype == "CIRC2009" & method == "VIP" & context == "phenotype",
.(SNP, score1 = score_scaled, rank1 = rank)]
dt1
dt1 <- all_scores_dt[phenotype == "CIRC2009" & method == "VIP" & context == "residuals",
.(SNP, score1 = score_scaled, rank1 = rank)]
dt1
dt1 <- all_scores_dt[phenotype == c("CIRC2009") & method == "VIP" & context == "residuals",
.(SNP, score1 = score_scaled, rank1 = rank)]
dt1
dt1 <- all_scores_dt[phenotype == c("CIRC2009","HT2009") & method == "VIP" & context == "residuals",
.(SNP, score1 = score_scaled, rank1 = rank)]
dt1 <- all_scores_dt[phenotype == "CIRC2009"& phenotype =="HT2009" & method == "VIP" & context == "residuals",
.(SNP, score1 = score_scaled, rank1 = rank)]
dt1
dt1 <- all_scores_dt[phenotype == "CIRC2009" & method == "VIP" & context == "residuals",
.(SNP, score1 = score_scaled, rank1 = rank)]
dt1
dt1 <- all_scores_dt[phenotype == "Rust" & method == "VIP" & context == "residuals",
.(SNP, score1 = score_scaled, rank1 = rank)]
dt1
dt1 <- all_scores_dt[phenotype == "Rust" & method == "VIP" & context == "residuals", order(rank1),
.(SNP, score1 = score_scaled, rank1 = rank)]
dt1
dt1 <- all_scores_dt[phenotype == "Rust" & method == "VIP" & context == "residuals",
.(SNP, score1 = score_scaled, rank1 = rank)]
dt1 <- dt1[ order(rank1)]
dt1
dt1 <- all_scores_dt[phenotype == "Rust" & method == "VIP" & context == "residuals",
.(SNP, score1 = score_scaled, rank1 = rank)]
dt1 <- dt1[ order(rank1)]
dt1
dt2 <- all_scores_dt[phenotype == "HT2009" & method == "VIP" & context == "residuals",
.(SNP, score2 = score_scaled , rank2 = rank)]
dt2 <- dt2[ order(rank2)]
dt2
compare_scores <- function(scores_dt, topK = 10000) {
# Corrélation de Spearman sur tous les SNPs
spearman_all <- cor(scores_dt$score1, scores_dt$score2, method = "spearman")
# Recouvrement des TOP K
top1 <- scores_dt[order(rank1)][1:topK, SNP]
top2 <- scores_dt[order(rank2)][1:topK, SNP]
overlap <- length(intersect(top1, top2))
overlap_prop <- overlap / topK
return(list(
spearman_all = spearman_all,
topK_overlap = overlap,
topK_overlap_prop = overlap_prop
))
}
plot_scores_comparison <- function(scores_dt, pheno, method) {
ggplot(scores_dt, aes(x = score1, y = score2)) +
geom_point(alpha = 0.5) +
geom_smooth(method = "lm", color = "blue") +
labs(
x = "rang brut",
y = "rang résidus",
title = paste("Comparaison scores SNP |", pheno, "|", method)
) +
theme_minimal()
}
phenos <- c("CIRC2009","CIRC2011","HT2009","BudFlushSlope")
methods <- c("RF")
results_list <- list()
plots_list <- list()
for (ph in phenos) {
for (m in methods) {
scores_dt <- get_scores_for_pheno(all_scores_dt, ph, m, "phenotype", "residuals")
comp <- compare_scores(scores_dt, topK = 100)
results_list[[paste(ph, m, sep = "_")]] <- comp
plots_list[[paste(ph, m, sep = "_")]] <- plot_scores_comparison(scores_dt, ph, m)
}
}
results_list$CIRC2009_RF
results_list$CIRC2011_RF
results_list$HT2009_RF
results_list$BudFlushSlope_RF
plots_list$CIRC2009_RF
plots_list$CIRC2011_RF
phenos <- c("CIRC2011","HT2009")
methods <- c("RF","VIP")
results_list <- list()
plots_list <- list()
for (ph in phenos) {
for (m in methods) {
scores_dt <- get_scores_for_pheno(all_scores_dt, ph, m, "phenotype", "residuals")
comp <- compare_scores(scores_dt, topK = 100)
results_list[[paste(ph, m, sep = "_")]] <- comp
plots_list[[paste(ph, m, sep = "_")]] <- plot_scores_comparison(scores_dt, ph, m)
}
}
names(results_list)
results_list$CIRC2011_RF
results_list$CIRC2011_VIP
results_list$HT2009_RF
results_list$HT2009_VIP
phenos <- c("CIRC2011","HT2009")
methods <- c("RF","VIP")
results_list <- list()
plots_list <- list()
for (ph in phenos) {
for (m in methods) {
scores_dt <- get_scores_for_pheno(all_scores_dt, ph, m, "phenotype", "residuals")
comp <- compare_scores(scores_dt, topK = 1000)
results_list[[paste(ph, m, sep = "_")]] <- comp
plots_list[[paste(ph, m, sep = "_")]] <- plot_scores_comparison(scores_dt, ph, m)
}
}
results_list$CIRC2011_RF
results_list$CIRC2011_VIP
results_list$HT2009_RF
results_list$HT2009_VIP
phenos <- c("CIRC2011","HT2009")
methods <- c("RF","VIP")
results_list <- list()
plots_list <- list()
for (ph in phenos) {
for (m in methods) {
scores_dt <- get_scores_for_pheno(all_scores_dt, ph, m, "phenotype", "residuals")
comp <- compare_scores(scores_dt, topK = 100)
results_list[[paste(ph, m, sep = "_")]] <- comp
plots_list[[paste(ph, m, sep = "_")]] <- plot_scores_comparison(scores_dt, ph, m)
}
}
