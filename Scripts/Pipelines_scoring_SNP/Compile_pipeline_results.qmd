---
title: "Compile_pipeline_results"
format: html
editor: visual
---

liste des fichiers corrupted :

"results/RF_scores_res/RF_Rust/RF_scores_all_Rust.rds"

results/RF_scores/RF_Rust/RF_scores_all_Rust.rds"

results/VIP_scores/VIP_CIRC2009/VIP_scores_all_CIRC2009.rds

```{r}

library(data.table)
library(stringr)
library(future)
library(future.apply)
```

```{r}

DIRS <- list(
  VIP_pheno = list(
    root    = "results/VIP_scores_res",
    method  = "VIP",
    context = "residuals",
    score_col = "VIP"
  ),
  RF_resid = list(
    root    = "results/VIP_scores",
    method  = "VIP",
    context = "phenotype",
    score_col = "VIP"
  ),
    RF = list(
    root    = "results/RF_scores",
    method  = "RF",
    context = "phenotype",
    score_col = "importance"
  ),
    RF = list(
    root    = "results/RF_scores_res",
    method  = "RF",
    context = "residuals",
    score_col = "importance"
  )
)

```

```{r}

DIRS <- list(
    RF = list(
    root    = "results/VIP_scores_multi_null",
    method  = "VIP",
    context = "phenotype",
    score_col = "VIP"
  ),
    RF_resid = list(
    root    = "results/VIP_scores_multi_res_phenonull",
    method  = "VIP",
    context = "residuals",
    score_col = "VIP"
  )
)

```

```{r}
read_score_dir <- function(root, method, context, score_col) {
  print(c("traitement de >>>",root))
  pheno_dirs <- list.dirs(root, recursive = FALSE, full.names = TRUE)
  
  print(c("pour les phénotypes :",pheno_dirs))

  res <- lapply(pheno_dirs, function(d) {
    phenotype <- basename(d)
    phenotype <- str_remove(phenotype, "^(VIP|RF)_")
    
    print(c("phénotype >>>",phenotype))
    
    score_file <- list.files(
      d,
      pattern = "_scores_all_.*\\.rds$",
      full.names = TRUE
    )

    if (length(score_file) != 1) return(NULL)

    dt <- readRDS(score_file)

    if (!all(c("SNP", score_col) %in% colnames(dt))) return(NULL)

    dt[
      ,
      .(
        scores_raw = list(get(score_col)),
        n_obs      = .N,
        mean       = mean(get(score_col)),
        median     = median(get(score_col)),
        sd         = sd(get(score_col)),
        q95        = quantile(get(score_col), 0.95),
        max        = max(get(score_col))
      ),
      by = SNP
    ][
      ,
      `:=`(
        phenotype = phenotype,
        method    = method,
        context   = context
      )
    ]
  })
  print(">>> done")
  rbindlist(res, fill = TRUE)
}
```

```{r}
all_scores <- rbindlist(
  lapply(DIRS, function(x) {
    read_score_dir(
      root      = x$root,
      method    = x$method,
      context   = x$context,
      score_col = x$score_col
    )
  }),
  fill = TRUE
)
```

```{r}
setcolorder(
  all_scores,
  c(
    "SNP", "phenotype", "method", "context",
    "n_obs", "mean", "median", "sd", "q95", "max",
    "scores_raw"
  )
)

tmp_file <- tempfile(fileext = ".parquet")
write_parquet(all_scores, tmp_file)

final_file <- "results/all_scores_pheno_null_VIP.parquet"
file.rename(tmp_file, final_file)

```

```{r}
pheno_sel <- "Rust"
context_sel   <- "residuals"
method_sel    <- "RF"

dt <- all_scores[
  method   == method_sel &
  phenotype == pheno_sel &
  context  == context_sel,
  .(SNP, mean, method, context)
]
```

### Merge en parquet

```{r}
library(arrow)
```

```{r}
dt1 <- read_parquet("results/gwas_all_results.parquet", as_data_table = TRUE)
```

```{r}

unique(dt1$phenotype)
```
```{r}
dt_all
```


```{r}
dt2 <- read_parquet("results/all_scores_pheno_null_VIP.parquet", as_data_table = TRUE)
```

```{r}
dt_all <- rbind(dt_all, dt1, use.names = TRUE, fill = TRUE)


tmp_file <- tempfile(fileext = ".parquet")
write_parquet(dt_all, tmp_file)

# Puis on déplace le fichier temporaire vers le chemin final
final_file <- "results/all_scores_merged.parquet"
file.rename(tmp_file, final_file)

```
