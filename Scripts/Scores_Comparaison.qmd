---
title: "Scores_Comparaison"
format: html
editor: visual
---

```{r}
library(pls)
library(caret)
library(data.table)
library(parallel)
library(doParallel)
library(data.table)
library(ggplot2)
library(nnet)
library(pls)
library(FactoMineR)
library(qqman)
library(mixOmics)
library(glmnet)
library(corrplot)
```


## leccture des scores

```{r}
library(arrow)
cols_to_read <- c(
  "SNP", "phenotype", "method", "context",
  "n_obs", "mean", "median", "sd", "q90", "q95", "max"
)
all_scores_dt <- read_parquet("Pipelines_scoring_SNP/results/all_scores.parquet",
                              as_data_table = TRUE,
                              col_select = cols_to_read)

# Classement basé sur la moyenne

# colonne 'mean' comme score global pour le ranking
all_scores_dt[, rank := frank(mean, ties.method = "average"), by = .(phenotype, method, context)]


# 1. Z-score
all_scores_dt[, score_z := (mean - mean(mean, na.rm = TRUE)) / sd(mean, na.rm = TRUE),
              by = .(phenotype, method, context)]

# 2. Min-max scaling sur le z-score pour avoir 0-1
all_scores_dt[, score_scaled_01 := (score_z - min(score_z, na.rm = TRUE)) /
                                  (max(score_z, na.rm = TRUE) - min(score_z, na.rm = TRUE)),
              by = .(phenotype, method)]

all_scores_dt[, method_context := paste(method, context, sep = "_")]
all_scores_dt[, method_context := factor(method_context, levels = unique(method_context))]
```


```{r}
tmp <- tstrsplit(all_scores_dt$SNP, "_")
all_scores_dt[, chrom := tmp[[1]]]
all_scores_dt[, pos   := as.numeric(tmp[[2]])]

all_scores_dt[, chrom_num := as.numeric(sub("^Chr", "", chrom))]
```



```{r}
head(all_scores_dt)
```


```{r}
#plot(density(all_scores_dt[method == "VIP"]$rank, kernel = "gaussian", adjust = 1))
plot(density(all_scores_dt[method == "VIP" & phenotype == "BrAnglVert" ]$score_scaled_01, kernel = "gaussian", adjust = 1))
```

```{r}
library(data.table)
library(ggplot2)
library(ggridges)

# Liste des phénotypes
phenotypes <- unique(all_scores_dt$phenotype)

# Boucle pour générer un plot par phénotype
for(ph in phenotypes){
  
  tmp_dt <- all_scores_dt[phenotype == ph]
  
  p <- ggplot(tmp_dt, aes(x = score_scaled_01, y = method_context, fill = method_context)) +
    geom_density_ridges(alpha = 0.6, scale = 1.2, rel_min_height = 0.01) +
    scale_fill_cyclical(values = c("#1b9e77","#d95f02","#7570b3","#e7298a"), guide = "none") +
    theme_ridges(font_size = 12, grid = TRUE) +
    theme(axis.title.y = element_blank(),
          axis.text.y = element_text(size = 10),
          plot.title = element_text(size = 14, face = "bold")) +
    labs(title = paste0("Distribution des scores pour le phénotype : ", ph),
         x = "Score moyen")
  
  print(p)
  
  # Optionnel : sauvegarder chaque plot
  # ggsave(filename = paste0("ridgeline_", ph, ".png"), plot = p, width = 8, height = 5)
}


```



## Manahattan plot !

```{r}
pheno_sel <- "HT2009"
context_sel   <- "phenotype"
method_sel    <- "RF"

dt <- all_scores_dt[
  method   == method_sel &
  phenotype == pheno_sel &
  context  == context_sel,
  .(SNP, score_scaled_01,chrom_num,pos)
]
dt <- dt[!is.na(chrom_num)]

manhattan(
  dt,
  chr = "chrom_num",
  bp = "pos",
  p = "score_scaled_01",
  snp = "SNP",
  col = c("gray10", "gray60"),
  chrlabs = NULL,
  highlight = NULL,
  annotatePval = NULL,
  annotateTop = TRUE,
  logp = FALSE
)

pheno_sel <- "CIRC2009"
context_sel   <- "phenotype"
method_sel    <- "RF"

dt2 <- all_scores_dt[
  method   == method_sel &
  phenotype == pheno_sel &
  context  == context_sel,
  .(SNP, score_scaled_01,chrom_num,pos)
]

dt2 <- dt2[!is.na(chrom_num)]

manhattan(
  dt2,
  chr = "chrom_num",
  bp = "pos",
  p = "score_scaled_01",
  snp = "SNP",
  col = c("gray10", "gray60"),
  chrlabs = NULL,
  highlight = NULL,
  annotatePval = NULL,
  annotateTop = TRUE,
  logp = FALSE
)
```


# YEAHHHHHH

```{r}
get_scores_for_pheno <- function(dt, pheno, method, context1, context2) {
  dt1 <- dt[phenotype == pheno & method == method & context == context1,
            .(SNP, score1 = score_scaled, rank1 = rank)]
  dt2 <- dt[phenotype == pheno & method == method & context == context2,
            .(SNP, score2 = score_scaled , rank2 = rank)]
  merged <- merge(dt1, dt2, by = "SNP")
  return(merged)
}
```





```{r}
library(data.table)
library(ggplot2)

compare_pheno_pair_safe <- function(dt, ph1, ph2, method_sel, context_sel, topK = 1000) {
  
  # Extraire les scores et retirer les NA
  dt1 <- dt[phenotype == ph1 & method == method_sel & context == context_sel,
            .(SNP, score1 = score_scaled, rank1 = rank)]
  dt1 <- dt1[!is.na(score1)]
  
  dt2 <- dt[phenotype == ph2 & method == method_sel & context == context_sel,
            .(SNP, score2 = score_scaled, rank2 = rank)]
  dt2 <- dt2[!is.na(score2)]
  
  # Merge en gardant seulement les SNPs communs
  merged <- merge(dt1, dt2, by = "SNP")
  
  # Si pas de SNP commun
  if(nrow(merged) == 0) {
    return(data.table(
      pheno1 = ph1, pheno2 = ph2,
      method = method_sel, context = context_sel,
      spearman = NA_real_, topK_overlap = NA_real_
    ))
  }
  
  # Corrélation de Spearman
  spearman <- cor(merged$score1, merged$score2, method = "spearman", use = "complete.obs")
  
  # TOP K overlap
  top1 <- merged[order(rank1)][1:min(topK, .N), SNP]
  top2 <- merged[order(rank2)][1:min(topK, .N), SNP]
  overlap_prop <- length(intersect(top1, top2)) / min(topK, .N)
  
  data.table(
    pheno1 = ph1, pheno2 = ph2,
    method = method_sel, context = context_sel,
    spearman = spearman, topK_overlap = overlap_prop
  )
}


compare_all_phenos_full_safe <- function(dt, phenos, method_sel, context_sel, topK = 1000) {
  res_list <- list()
  for(ph1 in phenos) {
    for(ph2 in phenos) {
      res_list[[length(res_list)+1]] <- compare_pheno_pair_safe(
        dt, ph1, ph2, method_sel, context_sel, topK
      )
    }
  }
  rbindlist(res_list)
}
```

```{r}

####################################
############ RF ####################
####################################

phenos_run <- c("CIRC2009","CIRC2011","HT2009","BudFlushSlope","BrAnglVert","Dia2015_sqrt","RamifSyllep")
method_run <- "RF"
context_run <- "phenotype"
topK_run <- 1000

RF_res_pheno <- compare_all_phenos_full_safe(all_scores_dt, phenos_run, method_run, context_run, topK_run)

phenos_run <- c("CIRC2009","CIRC2011","HT2009","BudFlushSlope","BrAnglVert","Dia2015_sqrt","RamifSyllep")
method_run <- "RF"
context_run <- "residuals"
topK_run <- 1000

RF_res_res <- compare_all_phenos_full_safe(all_scores_dt, phenos_run, method_run, context_run, topK_run)


####################################
############ VIP ###################
####################################


phenos_run <- c("CIRC2009","CIRC2011","HT2009","BudFlushSlope","BrAnglVert","Dia2015_sqrt","RamifSyllep")
method_run <- "VIP"
context_run <- "phenotype"
topK_run <- 1000

VIP_res_pheno <- compare_all_phenos_full_safe(all_scores_dt, phenos_run, method_run, context_run, topK_run)

phenos_run <- c("CIRC2009","CIRC2011","HT2009","BudFlushSlope","BrAnglVert","Dia2015_sqrt","RamifSyllep")
method_run <- "VIP"
context_run <- "residuals"
topK_run <- 1000

VIP_res_res <- compare_all_phenos_full_safe(all_scores_dt, phenos_run, method_run, context_run, topK_run)



```
```{r}
VIP_res_res
```


```{r}
# Ajouter une colonne pour indiquer le contexte
RF_res_pheno[, context := "RF_phenotype"]
RF_res_res[, context := "RF_residuals"]

VIP_res_pheno[, context := "VIP_phenotype"]
VIP_res_res[, context := "VIP_residuals"]

# Fusionner les deux résultats pour comparer
res_all <- rbind(RF_res_pheno, RF_res_res,VIP_res_pheno,VIP_res_res)
```

```{r}
# Heatmap Spearman
ggplot(res_all, aes(x = pheno1, y = pheno2, fill = spearman)) +
  geom_tile() +
  facet_wrap(~ context) +
  scale_fill_gradient2(low = "blue", mid = "white", high = "red", midpoint = 0) +
  theme_minimal() +
  labs(
    title = "Spearman correlation sur les scores de l'ensemble des SNP entre phénotypes",
    fill = "rho"
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Heatmap TOP K overlap
ggplot(res_all, aes(x = pheno1, y = pheno2, fill = topK_overlap)) +
  geom_tile() +
  facet_wrap(~ context) +
  scale_fill_gradient(low = "white", high = "red") +
  theme_minimal() +
  labs(
    title = paste0("Proportion TOP ", topK_run, " SNPs communs entre phénotypes"),
    fill = "TOP K overlap"
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```
```{r}
#method_context == "RF_residuals"
#,"Chr02", "Chr03","Chr04","Chr05","Chr01","Chr06"
ggplot(all_scores_dt[method_context %in% c("RF_residuals","RF_phenotype","VIP_phenotype","VIP_residuals") &
                     chrom %in% c("Chr13") &
                     phenotype %in% c("CIRC2009","CIRC2011","HT2009","BrAnglVert")],
       aes(x = pos, y = score_scaled_01, color = phenotype, alpha = score_scaled_01)) +
  geom_point(size = 1) +
  facet_grid(method_context ~ chrom, scales = "free_x") +
  theme_minimal() +
  labs(title = "Scores moyens des SNP du chromosome 13 par phénotype et méthode de scoring",
       x = "Position SNP",
       y = "Score normalisé",
       alpha = "Score") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```
```{r}
head(all_scores_dt)
```

```{r}
library(FactoMineR)
library(factoextra)

# Matrice SNP x Phénotype
snp_mat <- dcast(all_scores_dt[method_context == "RF_residuals"], SNP ~ phenotype, value.var = "mean", fill = 0)
rownames(snp_mat) <- snp_mat$SNP
snp_mat$SNP <- NULL
res.pca <- PCA(snp_mat, graph = FALSE)
chrom_factor <- factor(all_scores_dt$chrom_num[match(rownames(snp_mat), all_scores_dt$SNP)])

fviz_pca_ind(res.pca, 
             geom = "point", 
             col.ind = chrom_factor,  # <- facteur, pas numérique
             palette = "jco", 
             addEllipses = TRUE,
             legend.title = "Chromosome")
```

```{r}
snp_mat <- dcast(all_scores_dt[method_context == "RF_phenotype"], SNP ~ phenotype, value.var = "mean", fill = 0)
rownames(snp_mat) <- snp_mat$SNP
snp_mat$SNP <- NULL
res.pca <- PCA(snp_mat, graph = FALSE)
chrom_factor <- factor(all_scores_dt$chrom_num[match(rownames(snp_mat), all_scores_dt$SNP)])

fviz_pca_ind(res.pca, 
             geom = "point", 
             col.ind = chrom_factor,  # <- facteur, pas numérique
             palette = "jco", 
             legend.title = "Chromosome")

```
```{r}
snp_mat <- dcast(all_scores_dt[method_context == "VIP_residuals"], SNP ~ phenotype, value.var = "score_scaled", fill = 0)
rownames(snp_mat) <- snp_mat$SNP
snp_mat$SNP <- NULL
res.pca <- PCA(snp_mat, graph = FALSE)
chrom_factor <- factor(all_scores_dt$chrom_num[match(rownames(snp_mat), all_scores_dt$SNP)])

fviz_pca_ind(res.pca, 
             geom = "point", 
             col.ind = chrom_factor,  # <- facteur, pas numérique
             palette = "jco", 
             legend.title = "Chromosome")
```

```{r}
# Top 100 SNP pour un phénotype donné
topK <- 100
pheno_sel <- "CIRC2011"

top_snps <- all_scores_dt[phenotype == pheno_sel & method_context == "VIP_residuals", .SD[order(-score_scaled)][1:topK], by=phenotype]$SNP

# Ajouter colonne topK dans la table
all_scores_dt[, is_topK := SNP %in% top_snps]

```



```{r}
top_snps_vec <- rownames(snp_mat) %in% top_snps

# Vérifier
length(top_snps_vec)  # doit être égal à nrow(snp_mat)

# PCA avec top K mis en évidence
fviz_pca_ind(res.pca,
             geom = "point",
             col.ind = ifelse(top_snps_vec, "topK", "other"),
             palette = c("red", "grey"),
             legend.title = "Top SNP")
```


```{r}
compare_scores <- function(scores_dt, topK = 10000) {
  # Corrélation de Spearman sur tous les SNPs
  spearman_all <- cor(scores_dt$score1, scores_dt$score2, method = "spearman")
  
  # Recouvrement des TOP K
  top1 <- scores_dt[order(rank1)][1:topK, SNP]
  top2 <- scores_dt[order(rank2)][1:topK, SNP]
  overlap <- length(intersect(top1, top2))
  overlap_prop <- overlap / topK
  
  return(list(
    spearman_all = spearman_all,
    topK_overlap = overlap,
    topK_overlap_prop = overlap_prop
  ))
}

plot_scores_comparison <- function(scores_dt, pheno, method) {
  ggplot(scores_dt, aes(x = score1, y = score2)) +
    geom_point(alpha = 0.5) +
    geom_smooth(method = "lm", color = "blue") +
    labs( 
      x = "rang brut",
      y = "rang résidus",
      title = paste("Comparaison scores SNP |", pheno, "|", method)
    ) +
    theme_minimal()
}

```

```{r}
phenos <- c("CIRC2011","HT2009")
methods <- c("RF","VIP")   

results_list <- list()
plots_list <- list()

for (ph in phenos) {
  for (m in methods) {
    scores_dt <- get_scores_for_pheno(all_scores_dt, ph, m, "phenotype", "residuals")
    comp <- compare_scores(scores_dt, topK = 100)
    results_list[[paste(ph, m, sep = "_")]] <- comp
    plots_list[[paste(ph, m, sep = "_")]] <- plot_scores_comparison(scores_dt, ph, m)
  }
}

```

```{r}
names(results_list)
```

```{r}

results_list$CIRC2011_RF
results_list$CIRC2011_VIP
results_list$HT2009_RF
results_list$HT2009_VIP

```

```{r}
plots_list$CIRC2009_RF
plots_list$CIRC2011_RF
```

```{r}
plots_list$HT2009_RF
plots_list$BudFlushSlope_RF
```


# ACP scores 
AFM par phénotype avec les 4 modalités de méthodes et les chromosomes en position => 1 tableau = modalité x méthode 
```{r}
library(FactoMineR)

```
```{r}
head(all_scores_dt)
```


```{r}
sum(is.numeric(as.numeric(all_scores_dt[phenotype == "HT2009" & method == "RF" ,c(6)])))
```

```{r}
PCA(all_scores_dt[phenotype == "HT2009" & method == "RF" ,c(6,4,17)],ncp = 2, quanti.sup =c(2,3) )
```








